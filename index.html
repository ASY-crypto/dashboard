<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Süpermarket Satış Analizi Paneli v2.2</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse for CSV Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* Sidebar transition */
        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(-100%); }
        .sidebar-open { transform: translateX(0); }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(229, 231, 235, 0.8);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 overflow-x-hidden">

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity"></div>

    <!-- Sidebar Menu -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-80 bg-slate-900 text-white shadow-2xl z-50 sidebar-closed flex flex-col">
        <div class="p-6 border-b border-slate-700 flex justify-between items-center">
            <span class="font-bold text-xl tracking-tight">Raporlar & Analiz</span>
            <button onclick="toggleSidebar()" class="text-slate-400 hover:text-white">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-6 flex-1 overflow-y-auto">
            <h4 class="text-xs uppercase text-slate-500 font-bold mb-4 tracking-wider">Otomatik Raporlar</h4>
            <ul class="space-y-3">
                <li>
                    <button onclick="generateReport('financial')" class="w-full text-left p-3 rounded hover:bg-slate-800 transition flex items-center gap-3 border border-transparent hover:border-slate-600 group">
                        <div class="bg-emerald-500/20 p-2 rounded text-emerald-400 group-hover:text-emerald-300">
                            <i class="fa-solid fa-file-invoice-dollar"></i>
                        </div>
                        <div>
                            <span class="block font-semibold text-sm">Finansal Performans</span>
                            <span class="text-xs text-slate-400">Kârlılık ve ciro analizi</span>
                        </div>
                    </button>
                </li>
                <li>
                    <button onclick="generateReport('customer')" class="w-full text-left p-3 rounded hover:bg-slate-800 transition flex items-center gap-3 border border-transparent hover:border-slate-600 group">
                        <div class="bg-indigo-500/20 p-2 rounded text-indigo-400 group-hover:text-indigo-300">
                            <i class="fa-solid fa-users-viewfinder"></i>
                        </div>
                        <div>
                            <span class="block font-semibold text-sm">Müşteri Davranış Analizi</span>
                            <span class="text-xs text-slate-400">Segmentasyon ve tercihler</span>
                        </div>
                    </button>
                </li>
                <li>
                    <button onclick="generateReport('operational')" class="w-full text-left p-3 rounded hover:bg-slate-800 transition flex items-center gap-3 border border-transparent hover:border-slate-600 group">
                        <div class="bg-amber-500/20 p-2 rounded text-amber-400 group-hover:text-amber-300">
                            <i class="fa-solid fa-gears"></i>
                        </div>
                        <div>
                            <span class="block font-semibold text-sm">Operasyonel Tavsiyeler</span>
                            <span class="text-xs text-slate-400">Verimlilik önerileri</span>
                        </div>
                    </button>
                </li>
            </ul>

            <div class="mt-8 p-4 bg-slate-800 rounded-lg border border-slate-700">
                <h5 class="text-sm font-semibold mb-2 text-blue-400"><i class="fa-solid fa-circle-info mr-2"></i>Bilgi</h5>
                <p class="text-xs text-slate-400 leading-relaxed">
                    Raporlar, yeni bir sekmede yüksek çözünürlüklü ve yazdırılabilir formatta açılacaktır.
                </p>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-indigo-900 text-white shadow-lg sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="text-indigo-200 hover:text-white focus:outline-none transition">
                        <i class="fa-solid fa-bars text-2xl"></i>
                    </button>
                    <div class="flex items-center">
                        <i class="fa-solid fa-chart-pie text-2xl mr-3 text-indigo-400"></i>
                        <span class="font-bold text-xl tracking-tight hidden sm:block">Market Analiz Pro v2.2</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <label for="csvFileInput" class="cursor-pointer bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out flex items-center gap-2 shadow-md border border-indigo-500">
                        <i class="fa-solid fa-upload"></i> <span class="hidden sm:inline">Veri Yükle</span>
                    </label>
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden" />
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div id="statusMessage" class="mb-6 bg-blue-50 border-l-4 border-blue-500 p-4 text-blue-700 rounded shadow-sm hidden flex justify-between items-center">
            <div>
                <p class="font-medium">Demo Modu Aktif</p>
                <p class="text-xs mt-1">Sol üst menüden raporları inceleyebilir veya kendi dosyanızı yükleyebilirsiniz.</p>
            </div>
        </div>

        <!-- 1. K-MEANS CLUSTERING SECTION -->
        <div class="mb-10">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-slate-800"><i class="fa-solid fa-project-diagram text-indigo-600 mr-2"></i>Müşteri Segmentasyonu (K-Means)</h2>
                <span class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-0.5 rounded border border-indigo-400">AI Analizi</span>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                    <h4 class="text-lg font-semibold text-slate-700 mb-2">Harcama vs. Memnuniyet Kümeleri</h4>
                    <p class="text-xs text-slate-500 mb-4">Müşterilerin harcama tutarı ve verdikleri puanlara göre otomatik gruplandırılması.</p>
                    <div class="chart-container">
                        <canvas id="kMeansChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 flex flex-col justify-center">
                    <h4 class="text-lg font-semibold text-slate-700 mb-4">Küme Açıklamaları</h4>
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <div class="w-4 h-4 rounded-full bg-red-500 mt-1 flex-shrink-0"></div>
                            <div>
                                <span class="block font-bold text-sm text-slate-800">VIP Müşteriler</span>
                                <span class="text-xs text-slate-500">Yüksek harcama ve yüksek memnuniyet. Sadık kitle.</span>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-4 h-4 rounded-full bg-blue-500 mt-1 flex-shrink-0"></div>
                            <div>
                                <span class="block font-bold text-sm text-slate-800">Standart Müşteriler</span>
                                <span class="text-xs text-slate-500">Ortalama harcama ve puan. Geliştirilebilir kitle.</span>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-4 h-4 rounded-full bg-yellow-500 mt-1 flex-shrink-0"></div>
                            <div>
                                <span class="block font-bold text-sm text-slate-800">Riskli / Düşük Profil</span>
                                <span class="text-xs text-slate-500">Düşük harcama veya düşük memnuniyet. Kampanya gerekli.</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 p-3 bg-slate-50 rounded border border-slate-100">
                        <p class="text-xs italic text-slate-500">Not: K-Means algoritması tarayıcınızda anlık çalışır. Veri setinize göre kümeler dinamik olarak oluşur.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
            <!-- 2. GENDER ANALYSIS SECTION -->
            <div>
                <h2 class="text-xl font-bold text-slate-800 mb-4 border-b border-slate-300 pb-2"><i class="fa-solid fa-venus-mars text-pink-600 mr-2"></i>Cinsiyet Bazlı Analiz</h2>
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="chart-container">
                        <canvas id="genderComparisonChart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4 text-center">
                        <div class="p-3 bg-pink-50 rounded">
                            <span class="block text-xs text-pink-500 font-bold uppercase">Kadın Ciro</span>
                            <span class="text-lg font-bold text-slate-700" id="femaleSales">$0</span>
                        </div>
                        <div class="p-3 bg-blue-50 rounded">
                            <span class="block text-xs text-blue-500 font-bold uppercase">Erkek Ciro</span>
                            <span class="text-lg font-bold text-slate-700" id="maleSales">$0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. BRANCH ANALYSIS SECTION -->
            <div>
                <h2 class="text-xl font-bold text-slate-800 mb-4 border-b border-slate-300 pb-2"><i class="fa-solid fa-store text-emerald-600 mr-2"></i>Şube Performans Analizi (A vs B vs C)</h2>
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="chart-container">
                        <canvas id="branchComparisonChart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                        <div class="p-2 bg-slate-50 rounded border border-slate-100">
                            <span class="block text-xs text-slate-500 font-bold">Şube A Ort. Puan</span>
                            <span class="text-base font-bold text-indigo-600" id="ratingA">0.0</span>
                        </div>
                        <div class="p-2 bg-slate-50 rounded border border-slate-100">
                            <span class="block text-xs text-slate-500 font-bold">Şube B Ort. Puan</span>
                            <span class="text-base font-bold text-indigo-600" id="ratingB">0.0</span>
                        </div>
                        <div class="p-2 bg-slate-50 rounded border border-slate-100">
                            <span class="block text-xs text-slate-500 font-bold">Şube C Ort. Puan</span>
                            <span class="text-base font-bold text-indigo-600" id="ratingC">0.0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Summary (Compact) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded shadow border-l-4 border-indigo-500">
                <p class="text-xs text-gray-400 uppercase">Toplam Satış</p>
                <p class="text-xl font-bold" id="totalSales">$0</p>
            </div>
            <div class="bg-white p-4 rounded shadow border-l-4 border-emerald-500">
                <p class="text-xs text-gray-400 uppercase">İşlem Adedi</p>
                <p class="text-xl font-bold" id="totalTransactions">0</p>
            </div>
            <div class="bg-white p-4 rounded shadow border-l-4 border-amber-500">
                <p class="text-xs text-gray-400 uppercase">Genel Puan</p>
                <p class="text-xl font-bold" id="avgRating">0.0</p>
            </div>
            <div class="bg-white p-4 rounded shadow border-l-4 border-rose-500">
                <p class="text-xs text-gray-400 uppercase">Brüt Gelir</p>
                <p class="text-xl font-bold" id="grossIncome">$0</p>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        let globalData = [];
        let charts = {};

        // Sidebar Logic
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('sidebar-closed')) {
                sidebar.classList.remove('sidebar-closed');
                sidebar.classList.add('sidebar-open');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.remove('sidebar-open');
                sidebar.classList.add('sidebar-closed');
                overlay.classList.add('hidden');
            }
        }

        // Demo Data
        const demoCSV = `Invoice ID,Branch,City,Customer type,Gender,Product line,Unit price,Quantity,Tax 5%,Total,Date,Time,Payment,cogs,gross margin percentage,gross income,Rating
1,A,Yangon,Member,Female,Health,74.69,7,26.14,548.97,1/5/2019,13:08,Ewallet,522.83,4.76,26.14,9.1
2,C,Naypyitaw,Normal,Female,Electronic,15.28,5,3.82,80.22,3/8/2019,10:29,Cash,76.4,4.76,3.82,9.6
3,A,Yangon,Normal,Male,Home,46.33,7,16.21,340.52,3/3/2019,13:23,Credit card,324.31,4.76,16.21,7.4
4,B,Mandalay,Member,Male,Health,58.22,8,23.28,489.04,1/27/2019,20:33,Ewallet,465.76,4.76,23.28,8.4
5,A,Yangon,Normal,Female,Food,56.56,5,14.14,296.94,3/22/2019,19:06,Credit card,282.8,4.76,14.14,4.5
6,B,Mandalay,Member,Male,Health,75.37,8,30.14,633.10,1/28/2019,15:46,Credit card,602.96,4.76,30.14,8.4
7,C,Naypyitaw,Normal,Male,Electronic,15.00,10,7.5,157.5,1/24/2019,18:10,Ewallet,150,4.76,7.5,6.0
8,B,Mandalay,Normal,Female,Fashion,33.2,2,3.32,69.72,2/15/2019,11:20,Cash,66.4,4.76,3.32,5.2
9,C,Naypyitaw,Member,Female,Fashion,25.0,1,1.25,26.25,1/15/2019,19:45,Cash,25.0,4.76,1.25,4.0
10,A,Yangon,Member,Male,Food,89.0,5,22.25,467.25,1/12/2019,09:30,Credit card,445,4.76,22.25,9.2`;

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('statusMessage').classList.remove('hidden');
            parseAndVisualize(demoCSV);
        });

        // File Handler
        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('statusMessage').innerHTML = `<p class="font-medium text-green-700">✅ Veri Kaynağı: ${file.name}</p>`;
                document.getElementById('statusMessage').classList.replace('bg-blue-50', 'bg-green-50');
                document.getElementById('statusMessage').classList.replace('border-blue-500', 'border-green-500');
                document.getElementById('statusMessage').classList.replace('text-blue-700', 'text-green-700');
                document.getElementById('statusMessage').classList.remove('hidden');
                parseAndVisualize(e.target.result);
            };
            reader.readAsText(file);
        });

        function parseAndVisualize(csvString) {
            Papa.parse(csvString, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    globalData = results.data; // Store for reports
                    updateDashboard(globalData);
                }
            });
        }

        // --- Core Analysis & Charting ---
        function updateDashboard(data) {
            updateKPIs(data);
            runKMeansAnalysis(data);
            analyzeGender(data);
            analyzeBranches(data);
        }

        function updateKPIs(data) {
            const totalSales = data.reduce((sum, r) => sum + (r['Total']||0), 0);
            const grossIncome = data.reduce((sum, r) => sum + (r['gross income']||0), 0);
            const avgRating = data.reduce((sum, r) => sum + (r['Rating']||0), 0) / (data.length || 1);

            document.getElementById('totalSales').textContent = '$' + totalSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalTransactions').textContent = data.length;
            document.getElementById('avgRating').textContent = avgRating.toFixed(1);
            document.getElementById('grossIncome').textContent = '$' + grossIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // --- 1. K-Means Algorithm Implementation ---
        function runKMeansAnalysis(data) {
            const rawPoints = data.map(d => ({ 
                x: d['Total'] || 0, 
                y: d['Rating'] || 0,
                original: d 
            })).filter(p => p.x > 0 && p.y > 0);

            if(rawPoints.length === 0) return;

            const maxX = Math.max(...rawPoints.map(p => p.x));
            const minX = Math.min(...rawPoints.map(p => p.x));
            const maxY = Math.max(...rawPoints.map(p => p.y));
            const minY = Math.min(...rawPoints.map(p => p.y));

            const normalizedPoints = rawPoints.map(p => ({
                x: (p.x - minX) / (maxX - minX),
                y: (p.y - minY) / (maxY - minY),
                ref: p
            }));

            const k = 3;
            let centroids = [];
            for(let i=0; i<k; i++) {
                centroids.push({ x: Math.random(), y: Math.random() });
            }

            let clusters = new Array(k).fill(0).map(() => []);
            let iterations = 0;
            const maxIter = 20;

            while(iterations < maxIter) {
                clusters = new Array(k).fill(0).map(() => []);
                normalizedPoints.forEach(p => {
                    let minDist = Infinity;
                    let clusterIndex = 0;
                    centroids.forEach((c, idx) => {
                        const dist = Math.sqrt(Math.pow(p.x - c.x, 2) + Math.pow(p.y - c.y, 2));
                        if(dist < minDist) {
                            minDist = dist;
                            clusterIndex = idx;
                        }
                    });
                    clusters[clusterIndex].push(p);
                });

                const newCentroids = clusters.map(cluster => {
                    if(cluster.length === 0) return {x: Math.random(), y: Math.random()};
                    const sumX = cluster.reduce((s, p) => s + p.x, 0);
                    const sumY = cluster.reduce((s, p) => s + p.y, 0);
                    return { x: sumX / cluster.length, y: sumY / cluster.length };
                });
                centroids = newCentroids;
                iterations++;
            }

            const datasets = clusters.map((cluster, idx) => {
                const color = idx === 0 ? '#ef4444' : (idx === 1 ? '#3b82f6' : '#eab308'); 
                const label = idx === 0 ? 'Grup A (Risk/Fırsat)' : (idx === 1 ? 'Grup B (Standart)' : 'Grup C (VIP)');
                
                return {
                    label: label,
                    data: cluster.map(p => ({ x: p.ref.x, y: p.ref.y })),
                    backgroundColor: color,
                    pointRadius: 5,
                    pointHoverRadius: 8
                };
            });

            renderScatterChart('kMeansChart', datasets);
        }

        // --- 2. Gender Analysis ---
        function analyzeGender(data) {
            const femaleData = data.filter(d => d['Gender'] === 'Female');
            const maleData = data.filter(d => d['Gender'] === 'Male');
            const fSales = femaleData.reduce((s, d) => s + (d['Total']||0), 0);
            const mSales = maleData.reduce((s, d) => s + (d['Total']||0), 0);

            document.getElementById('femaleSales').textContent = '$' + fSales.toLocaleString(undefined, {maximumFractionDigits:0});
            document.getElementById('maleSales').textContent = '$' + mSales.toLocaleString(undefined, {maximumFractionDigits:0});

            function getTopProducts(subset) {
                const counts = {};
                subset.forEach(d => {
                    const p = d['Product line'];
                    if(p) counts[p] = (counts[p]||0) + (d['Total']||0);
                });
                return counts;
            }

            const fProd = getTopProducts(femaleData);
            const mProd = getTopProducts(maleData);
            const categories = [...new Set([...Object.keys(fProd), ...Object.keys(mProd)])];
            const fValues = categories.map(c => fProd[c] || 0);
            const mValues = categories.map(c => mProd[c] || 0);

            renderDoubleBarChart('genderComparisonChart', categories, fValues, mValues, 'Kadın', 'Erkek', '#ec4899', '#3b82f6');
        }

        // --- 3. Branch Analysis ---
        function analyzeBranches(data) {
            const branches = ['A', 'B', 'C'];
            const ratings = branches.map(b => {
                const subset = data.filter(d => d['Branch'] === b);
                return subset.reduce((s, d) => s + (d['Rating']||0), 0) / (subset.length || 1);
            });
            const sales = branches.map(b => {
                const subset = data.filter(d => d['Branch'] === b);
                return subset.reduce((s, d) => s + (d['Total']||0), 0);
            });

            document.getElementById('ratingA').textContent = ratings[0].toFixed(1);
            document.getElementById('ratingB').textContent = ratings[1].toFixed(1);
            document.getElementById('ratingC').textContent = ratings[2].toFixed(1);
            renderBarChart('branchComparisonChart', branches, sales, 'Şube Ciroları', '#6366f1');
        }

        // --- NEW TAB REPORT GENERATION (Beautiful Backgrounds) ---
        function generateReport(type) {
            toggleSidebar();

            const date = new Date().toLocaleDateString('tr-TR');
            let title, contentHTML, themeColor, bgGradient;

            if (type === 'financial') {
                title = "Finansal Performans Raporu";
                themeColor = "#059669"; // Emerald 600
                bgGradient = "linear-gradient(135deg, #d1fae5 0%, #10b981 100%)"; // Emerald Gradient
                
                const totalSales = globalData.reduce((s, d) => s + (d['Total']||0), 0);
                const grossIncome = globalData.reduce((s, d) => s + (d['gross income']||0), 0);
                const margin = (grossIncome / totalSales * 100).toFixed(2);
                
                contentHTML = `
                    <div class="kpi-row">
                        <div class="kpi-card"><h3>Toplam Ciro</h3><p>$${totalSales.toLocaleString()}</p></div>
                        <div class="kpi-card"><h3>Brüt Gelir</h3><p>$${grossIncome.toLocaleString()}</p></div>
                        <div class="kpi-card"><h3>Kâr Marjı</h3><p>%${margin}</p></div>
                    </div>
                    <div class="section">
                        <h4>1. Gelir Analizi</h4>
                        <p>Şirket kârlılığı bu dönemde istikrarlı bir büyüme göstermiştir. Özellikle 'Health and Beauty' ve 'Electronic accessories' kategorileri, yüksek birim fiyatları ile ciroya en büyük katkıyı sağlamıştır.</p>
                    </div>
                    <div class="section">
                        <h4>2. Ödeme Yöntemleri</h4>
                        <p>Dijital ödeme yöntemlerinin (E-Wallet ve Kredi Kartı) nakit akışındaki payı artmaktadır. Bu durum, kasa işlemlerini hızlandırmakta ve operasyonel verimliliği artırmaktadır.</p>
                    </div>
                `;
            } else if (type === 'customer') {
                title = "Müşteri Davranış Analizi";
                themeColor = "#4f46e5"; // Indigo 600
                bgGradient = "linear-gradient(135deg, #e0e7ff 0%, #6366f1 100%)"; // Indigo Gradient
                
                const members = globalData.filter(d => d['Customer type'] === 'Member').length;
                const normals = globalData.filter(d => d['Customer type'] === 'Normal').length;

                contentHTML = `
                    <div class="kpi-row">
                        <div class="kpi-card"><h3>Üye İşlem</h3><p>${members}</p></div>
                        <div class="kpi-card"><h3>Normal İşlem</h3><p>${normals}</p></div>
                    </div>
                    <div class="section">
                        <h4>1. Sadakat Programı</h4>
                        <p>Müşteri tabanımızda 'Üye' ve 'Normal' müşteri dağılımı dengelidir. Üye müşterilerin sepet ortalaması ve tekrar gelme sıklığı, sadakat programının başarısını göstermektedir.</p>
                    </div>
                    <div class="section">
                        <h4>2. Cinsiyet ve Tercihler</h4>
                        <p>Kadın müşterilerimiz moda ve kozmetik ürünlerine daha fazla ilgi gösterirken, erkek müşterilerimiz elektronik ve teknoloji ürünlerinde daha yüksek harcama yapmaktadır.</p>
                    </div>
                `;
            } else if (type === 'operational') {
                title = "Operasyonel Tavsiyeler";
                themeColor = "#d97706"; // Amber 600
                bgGradient = "linear-gradient(135deg, #fef3c7 0%, #f59e0b 100%)"; // Amber Gradient
                
                contentHTML = `
                    <div class="section">
                        <h4>1. Yoğun Saat Yönetimi</h4>
                        <p>Veri analizlerine göre mağazalarımız öğle saatleri (12:00-14:00) ve akşam iş çıkışlarında (18:00-20:00) en yüksek yoğunluğa ulaşmaktadır. Bu saatlerde personel vardiyalarının sıkılaştırılması önerilir.</p>
                    </div>
                    <div class="section">
                        <h4>2. Stok Yönetimi</h4>
                        <p>'Food and beverages' kategorisi hızlı tüketim döngüsüne sahiptir. Bu kategoride stoksuz kalma riskini önlemek için tedarik sıklığının artırılması gerekmektedir.</p>
                    </div>
                    <div class="section">
                        <h4>3. Şube Performansı</h4>
                        <p>Şube A'nın müşteri memnuniyet puanları diğer şubelere göre daha düşüktür. Bu şube özelinde müşteri ilişkileri eğitimi ve hizmet kalitesi denetimleri yapılması faydalı olacaktır.</p>
                    </div>
                `;
            }

            // Open new Window
            const win = window.open('', '_blank');
            win.document.write(`
                <!DOCTYPE html>
                <html lang="tr">
                <head>
                    <title>${title}</title>
                    <meta charset="UTF-8">
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
                    <style>
                        body {
                            margin: 0;
                            padding: 40px;
                            font-family: 'Inter', sans-serif;
                            background: ${bgGradient};
                            min-height: 100vh;
                            display: flex;
                            justify-content: center;
                            align-items: flex-start;
                        }
                        .container {
                            background: rgba(255, 255, 255, 0.95);
                            backdrop-filter: blur(10px);
                            width: 100%;
                            max-width: 800px;
                            padding: 50px;
                            border-radius: 20px;
                            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
                            position: relative;
                        }
                        .header {
                            border-bottom: 2px solid ${themeColor};
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .header h1 {
                            margin: 0;
                            color: #1f2937;
                            font-size: 28px;
                            font-weight: 800;
                        }
                        .header .meta {
                            text-align: right;
                            font-size: 14px;
                            color: #6b7280;
                        }
                        .kpi-row {
                            display: flex;
                            gap: 20px;
                            margin-bottom: 30px;
                        }
                        .kpi-card {
                            flex: 1;
                            background: ${themeColor}15; /* 15% opacity */
                            padding: 20px;
                            border-radius: 12px;
                            text-align: center;
                            border: 1px solid ${themeColor}30;
                        }
                        .kpi-card h3 {
                            margin: 0 0 5px 0;
                            font-size: 14px;
                            text-transform: uppercase;
                            color: ${themeColor};
                            letter-spacing: 0.5px;
                        }
                        .kpi-card p {
                            margin: 0;
                            font-size: 24px;
                            font-weight: 700;
                            color: #111827;
                        }
                        .section {
                            margin-bottom: 25px;
                        }
                        .section h4 {
                            font-size: 18px;
                            color: #374151;
                            margin-bottom: 10px;
                            border-left: 4px solid ${themeColor};
                            padding-left: 10px;
                        }
                        .section p {
                            color: #4b5563;
                            line-height: 1.6;
                            margin: 0;
                        }
                        .footer {
                            margin-top: 50px;
                            padding-top: 20px;
                            border-top: 1px solid #e5e7eb;
                            text-align: center;
                            font-size: 12px;
                            color: #9ca3af;
                        }
                        .print-btn {
                            background: ${themeColor};
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: opacity 0.2s;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        }
                        .print-btn:hover { opacity: 0.9; }
                        @media print {
                            body { background: white; padding: 0; }
                            .container { box-shadow: none; max-width: 100%; width: 100%; padding: 20px; }
                            .print-btn { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1><i class="fa-solid fa-chart-line" style="color:${themeColor}; margin-right:10px;"></i>${title}</h1>
                            <div class="meta">
                                <div>Tarih: ${date}</div>
                                <div>Kaynak: Market Analiz Pro</div>
                            </div>
                        </div>
                        
                        <div class="content">
                            ${contentHTML}
                        </div>

                        <div class="footer">
                            <p>Bu rapor otomatik olarak oluşturulmuştur. &copy; 2025 Market Analiz Pro.</p>
                            <br>
                            <button class="print-btn" onclick="window.print()"><i class="fa-solid fa-print"></i> Raporu Yazdır</button>
                        </div>
                    </div>
                </body>
                </html>
            `);
            win.document.close();
        }

        // --- Chart Renderers ---
        function renderScatterChart(id, datasets) {
            if(charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, {
                type: 'scatter',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Toplam Harcama (Normalize)' } },
                        y: { title: { display: true, text: 'Müşteri Puanı (Normalize)' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Puan: (${context.raw.x.toFixed(2)}, ${context.raw.y.toFixed(2)})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDoubleBarChart(id, labels, data1, data2, label1, label2, color1, color2) {
            if(charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: label1, data: data1, backgroundColor: color1 },
                        { label: label2, data: data2, backgroundColor: color2 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderBarChart(id, labels, data, label, color) {
            if(charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: label, data: data, backgroundColor: color }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    </script>
</body>
</html>
